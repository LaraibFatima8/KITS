<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLanzo Controller</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 h-screen">
  <div class="flex h-screen">
    <!-- Serial Console (Left) -->
    <div class="w-1/2 bg-gray-900 text-white flex flex-col">
      <div class="p-4 border-b border-gray-700">
        <h2 class="text-xl font-bold">Serial Log</h2>
      </div>
      <div class="flex-1 overflow-y-auto p-4">
        <pre id="receivedData" class="text-sm whitespace-pre-wrap leading-relaxed"></pre>
      </div>
      <div class="p-4 border-t border-gray-700">
        <button id="clearButton" class="w-full px-4 py-2 bg-gray-600 rounded-lg shadow hover:bg-gray-700">
          Clear Console
        </button>
      </div>
    </div>

    <!-- Control Panel (Right) -->
    <div class="w-1/2 overflow-y-auto p-6">
      <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">ü§ñ PLanzo Controller üìù</h1>

      <!-- Connection -->
      <div class="mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
        <h2 class="text-2xl font-bold text-blue-700 mb-4 text-center">Connection</h2>
        <div class="flex flex-col sm:flex-row gap-4">
          <button id="connectButton" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">
            Connect
          </button>
          <button id="disconnectButton" disabled class="flex-1 px-6 py-3 bg-red-500 text-white rounded-lg shadow hover:bg-red-600">
            Disconnect
          </button>
        </div>
        <p id="statusMessage" class="mt-4 text-center text-gray-700 font-medium"></p>
      </div>

      <!-- Study Config -->
      <div class="mb-8 p-6 bg-green-50 rounded-lg border border-green-200">
        <h2 class="text-2xl font-bold text-green-700 mb-4 text-center">Study Configuration</h2>
        <form id="configForm" class="space-y-4">
          <div>
            <label class="text-gray-700 font-medium">Alarm Time</label>
            <input type="time" id="alarmTime" required
              class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
          </div>
          <div>
            <label class="text-gray-700 font-medium">Study Duration (minutes)</label>
            <input type="number" id="studyDuration" required min="1" max="180" value="25"
              class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
          </div>
          <div>
            <label class="text-gray-700 font-medium">Reminder Note</label>
            <input type="text" id="reminder" maxlength="128" placeholder="Optional reminder"
              class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500">
          </div>
          <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">
            Save Configuration ‚ú®
          </button>
        </form>
      </div>

      <!-- Commands -->
      <div class="p-6 bg-indigo-50 rounded-lg border border-indigo-200">
        <h2 class="text-2xl font-bold text-indigo-700 mb-4 text-center">Quick Commands</h2>
        <div class="grid grid-cols-2 gap-4">
          <button class="command-button px-6 py-3 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700" data-command="START">
            ‚ñ∂ Start Timer
          </button>
          <button class="command-button px-6 py-3 bg-red-600 text-white rounded-lg shadow hover:bg-red-700" data-command="STOP">
            ‚èπ Stop Timer
          </button>
          <button class="command-button px-6 py-3 bg-yellow-600 text-white rounded-lg shadow hover:bg-yellow-700" data-command="PAUSE">
            ‚è∏ Pause Timer
          </button>
          <button class="command-button px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700" data-command="SHOW">
            üëÅ Show Status
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const connectButton = document.getElementById('connectButton');
      const disconnectButton = document.getElementById('disconnectButton');
      const statusMessage = document.getElementById('statusMessage');
      const receivedDataDisplay = document.getElementById('receivedData');
      const clearButton = document.getElementById('clearButton');
      const commandButtons = document.querySelectorAll('.command-button');
      const configForm = document.getElementById('configForm');

      let port, writer, reader, keepReading = true;
      let encoder = new TextEncoder();

      function updateConnectionButtons(connected) {
        connectButton.disabled = connected;
        disconnectButton.disabled = !connected;
        commandButtons.forEach(btn => btn.disabled = !connected);
        const submitBtn = configForm.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = !connected;
      }

      async function writeToSerial(data) {
        if (!port) return;
        try {
          if (!writer) writer = port.writable.getWriter();
          const now = new Date();
          data.deviceTime = { hours: now.getHours(), minutes: now.getMinutes(), seconds: now.getSeconds() };
          const dataToSend = JSON.stringify(data) + '\n';
          await writer.write(encoder.encode(dataToSend));
          logToConsole("Sent", dataToSend);
          writer.releaseLock(); writer = null;
        } catch (error) {
          statusMessage.textContent = `Write Error: ${error.message}`;
        }
      }

      function logToConsole(prefix, msg) {
        receivedDataDisplay.textContent += `\n[${prefix}] ${msg}`;
        receivedDataDisplay.scrollTop = receivedDataDisplay.scrollHeight;
      }

      async function readSerialData() {
        const decoder = new TextDecoder();
        while (port && keepReading) {
          try {
            const { value, done } = await reader.read();
            if (done) { reader.releaseLock(); break; }
            const text = decoder.decode(value).trim();
            if (text) {
              try {
                const obj = JSON.parse(text);
                logToConsole("ESP", JSON.stringify(obj, null, 2));
              } catch {
                logToConsole("RAW", text);
              }
            }
          } catch (error) {
            break;
          }
        }
      }

      connectButton.addEventListener('click', async () => {
        if (!('serial' in navigator)) {
          statusMessage.textContent = 'Web Serial not supported';
          return;
        }
        try {
          port = await navigator.serial.requestPort();
          await port.open({ baudRate: 9600 });
          reader = port.readable.getReader();
          updateConnectionButtons(true);
          statusMessage.textContent = 'Connected!';
          keepReading = true;
          readSerialData();
          await writeToSerial({ type: 'sync' });
          setInterval(() => { if (port) writeToSerial({ type: 'sync' }); }, 60000);
        } catch (error) {
          statusMessage.textContent = `Error: ${error.message}`;
        }
      });

      disconnectButton.addEventListener('click', async () => {
        if (reader) { keepReading = false; reader.cancel(); }
        if (writer) { writer.releaseLock(); writer = null; }
        if (port) await port.close();
        updateConnectionButtons(false);
        statusMessage.textContent = 'Disconnected';
      });

      configForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const config = {
          type: 'config',
          alarmTime: document.getElementById('alarmTime').value,
          studyDuration: parseInt(document.getElementById('studyDuration').value),
          reminder: document.getElementById('reminder').value || ''
        };
        for (let i=0;i<3;i++) { await writeToSerial(config); await new Promise(r=>setTimeout(r,100)); }
        statusMessage.textContent = 'Configuration sent!';
        setTimeout(()=>{ if(statusMessage.textContent==='Configuration sent!') statusMessage.textContent='Connected!'; },2000);
      });

      commandButtons.forEach(btn => btn.addEventListener('click', async () => {
        await writeToSerial({ type: 'command', action: btn.dataset.command });
      }));

      clearButton.addEventListener('click', () => { receivedDataDisplay.textContent = ''; });
      updateConnectionButtons(false);
    });
  </script>
</body>
</html>
